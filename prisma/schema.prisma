// Prisma Schema - Dashboard de Tráfego Pago
// PostgreSQL on Railway

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// AD ACCOUNT - Conta de anúncios
// ============================================
model AdAccount {
  id            String     @id @default(cuid())
  metaAccountId String     @unique @map("meta_account_id")
  name          String
  currency      String     @default("BRL")
  timezone      String     @default("America/Sao_Paulo")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  campaigns     Campaign[]

  @@map("ad_accounts")
}

// ============================================
// CAMPAIGN - Campanhas (equivalente aos "funis")
// ============================================
model Campaign {
  id             String    @id @default(cuid())
  metaCampaignId String    @map("meta_campaign_id")
  name           String
  status         String    @default("ACTIVE") // ACTIVE, PAUSED, DELETED
  objective      String?   // CONVERSIONS, TRAFFIC, etc

  adAccountId    String    @map("ad_account_id")
  adAccount      AdAccount @relation(fields: [adAccountId], references: [id], onDelete: Cascade)

  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  adSets         AdSet[]
  metrics        DailyMetric[]

  @@unique([adAccountId, metaCampaignId])
  @@map("campaigns")
}

// ============================================
// AD SET - Conjuntos de anúncios
// ============================================
model AdSet {
  id           String    @id @default(cuid())
  metaAdSetId  String    @map("meta_adset_id")
  name         String
  status       String    @default("ACTIVE")

  campaignId   String    @map("campaign_id")
  campaign     Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  ads          Ad[]
  metrics      DailyMetric[]

  @@unique([campaignId, metaAdSetId])
  @@map("ad_sets")
}

// ============================================
// AD - Anúncios individuais
// ============================================
model Ad {
  id          String    @id @default(cuid())
  metaAdId    String    @map("meta_ad_id")
  name        String
  status      String    @default("ACTIVE")
  creativeType String?  @map("creative_type") // VIDEO, IMAGE, CAROUSEL

  adSetId     String    @map("adset_id")
  adSet       AdSet     @relation(fields: [adSetId], references: [id], onDelete: Cascade)

  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  metrics     DailyMetric[]

  @@unique([adSetId, metaAdId])
  @@map("ads")
}

// ============================================
// DAILY METRICS - Métricas diárias (core do dashboard)
// ============================================
model DailyMetric {
  id        String   @id @default(cuid())
  date      DateTime @db.Date

  // Relacionamentos (granularidade flexível)
  campaignId String?  @map("campaign_id")
  campaign   Campaign? @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  adSetId    String?  @map("adset_id")
  adSet      AdSet?   @relation(fields: [adSetId], references: [id], onDelete: Cascade)

  adId       String?  @map("ad_id")
  ad         Ad?      @relation(fields: [adId], references: [id], onDelete: Cascade)

  // ============================================
  // MÉTRICAS BÁSICAS (existentes)
  // ============================================
  spend           Decimal  @default(0) @db.Decimal(12, 2)
  reach           Int      @default(0)
  impressions     Int      @default(0)
  clicks          Int      @default(0)
  linkClicks      Int      @default(0) @map("link_clicks")

  // ============================================
  // CONVERSÕES (existentes + novas)
  // ============================================
  purchases       Int      @default(0)
  purchaseValue   Decimal  @default(0) @map("purchase_value") @db.Decimal(12, 2) // Para ROAS
  leads           Int      @default(0)  // Para CPL
  registrations   Int      @default(0)  // Registro concluído
  addToCart       Int      @default(0) @map("add_to_cart")
  initiateCheckout Int     @default(0) @map("initiate_checkout")

  // ============================================
  // MÉTRICAS DE LANDING PAGE
  // ============================================
  landingPageViews     Int     @default(0) @map("landing_page_views") // NOVO
  costPerLandingPageView Decimal @default(0) @map("cost_per_landing_page_view") @db.Decimal(12, 4)

  // ============================================
  // MÉTRICAS DE VÍDEO (NOVAS - para Creative Analysis)
  // ============================================
  videoViews3s    Int      @default(0) @map("video_views_3s")  // Hook Rate
  videoThruPlays  Int      @default(0) @map("video_thru_plays") // ThruPlay
  videoP25        Int      @default(0) @map("video_p25")       // 25% watched
  videoP50        Int      @default(0) @map("video_p50")       // 50% watched
  videoP75        Int      @default(0) @map("video_p75")       // 75% watched
  videoP100       Int      @default(0) @map("video_p100")      // 100% watched
  videoAvgWatchTime Decimal @default(0) @map("video_avg_watch_time") @db.Decimal(10, 2) // segundos

  // ============================================
  // MÉTRICAS CALCULADAS PELO META (para validação)
  // ============================================
  frequency       Decimal  @default(0) @db.Decimal(8, 4)  // NOVO: Saturação
  cpm             Decimal  @default(0) @db.Decimal(12, 4)
  cpc             Decimal  @default(0) @db.Decimal(12, 4)
  ctr             Decimal  @default(0) @db.Decimal(8, 4)

  // ============================================
  // METADATA
  // ============================================
  source          String   @default("pabbly") // pabbly, manual, api
  rawPayload      Json?    @map("raw_payload") // Payload original para debug
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // Índices para queries rápidas
  @@unique([date, campaignId, adSetId, adId])
  @@index([date])
  @@index([campaignId, date])
  @@index([adSetId, date])
  @@index([adId, date])
  @@map("daily_metrics")
}

// ============================================
// FUNNEL CONFIG - Funis customizados pelo usuário
// ============================================
model FunnelConfig {
  id          String   @id @default(cuid())
  name        String   // Nome do funil ex: "VSL Produto X"
  description String?  // Descrição opcional
  color       String?  // Cor para identificação visual
  order       Int      @default(0) // Ordem de exibição
  isActive    Boolean  @default(true) @map("is_active")

  // Métrica de conversão principal: purchases, registrations, leads
  conversionMetric String @default("purchases") @map("conversion_metric")

  // Regras de filtro (JSON array)
  // Ex: [{"field": "campaign_name", "operator": "contains", "value": "VSL"}]
  rules       Json     @default("[]")

  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("funnel_configs")
}

// ============================================
// WEBHOOK LOG - Histórico de webhooks recebidos
// ============================================
model WebhookLog {
  id          String   @id @default(cuid())
  source      String   // pabbly, manual
  endpoint    String   // /api/webhook/meta
  method      String   // POST
  statusCode  Int      @map("status_code")
  payload     Json?
  error       String?
  processedAt DateTime @default(now()) @map("processed_at")

  @@index([processedAt])
  @@map("webhook_logs")
}
